# Lab overview

This repo describes my homelab Kubernetes platform:

- A **Proxmox** cluster runs multiple VMs.
- Those VMs form a **k3s** Kubernetes cluster.
- The cluster is managed using **FluxCD** (GitOps): the cluster continuously reconciles itself to match this Git repository.
- Ingress, TLS, auth, and persistence are provided by:
  - **Traefik** (ingress + routing)
  - **cert-manager** (Let's Encrypt DNS01 via Cloudflare)
  - **Authelia** (SSO/forward-auth + OIDC provider)
  - **Longhorn** (persistent storage for app config/data)
  - **NFS/TrueNAS** for bulk media and backups

---

## Repo Layout

### Cluster entrypoint (Flux reconciliation)
- `kubernetes/clusters/production/flux-system/`
  - Flux bootstrap manifests (generated by Flux; do not hand-edit)
  - Points Flux at this repo via SSH and reconciles `./kubernetes/clusters/production`

- `kubernetes/clusters/production/`
  - `infrastructure.yaml` → defines two Flux Kustomizations:
    - `infrastructure-controllers` → installs controllers/operators (HelmReleases, namespaces, Authelia manifests)
    - `infrastructure-configs` → cluster-wide configs and ingress routes (certificates, middleware, dashboards, external host routes)
  - `apps.yaml` → defines a Flux Kustomization applying all apps under `kubernetes/apps`

### Infrastructure
- `kubernetes/infrastructure/controllers/`
  - Namespaces
  - HelmRepositories / HelmReleases for:
    - cert-manager
    - traefik
    - longhorn
    - reflector
  - Authelia deployment + config templating
  - SOPS-encrypted secrets (Age)

- `kubernetes/infrastructure/configs/`
  - TLS issuance (ClusterIssuer + wildcard Certificate)
  - Shared middleware (Traefik forward-auth to Authelia)
  - IngressRoutes for:
    - Traefik dashboard
    - Longhorn UI
    - Authelia UI
    - ExternalName "host proxies" (pve, truenas, openwrt, adguard…)

### Apps
- `kubernetes/apps/<app>/`
  - Each app folder typically contains:
    - `deployment.yaml`
    - `service.yaml`
    - `ingress.yaml` (Traefik IngressRoute)
    - `pvc.yaml` (Longhorn config volumes and/or NFS mounts)
    - `pv.yaml` (only when using statically defined PVs, e.g. NFS)
    - `secret.yaml` (SOPS encrypted if needed)
    - `kustomization.yaml` (lists resources for that app)

---

## Network + Core Endpoints

### Cluster network (LAN)
- Node IPs are static in `192.168.5.0/24`
- Traefik exposes the cluster via a LoadBalancer IP:
  - `192.168.5.50`

### Internal services referenced by name
- `scale.lan` → TrueNAS / NFS server (bulk storage + Longhorn backups)
- `hades.lan`, `atlas.lan` → Proxmox hosts exposed via Traefik ExternalName routes

---

## VM Provisioning (Terraform → Proxmox)

### What Terraform does
Terraform uses the `telmate/proxmox` provider to:

- Clone Ubuntu templates on each Proxmox node
- Set static IP config via cloud-init
- Create:
  - k3s control-plane nodes
  - k3s worker nodes

### Proxmox nodes
- hades
- atlas
- venus

### VM roles (current)
Control-plane VMs:
- hades: `k3s-master-01` (192.168.5.20), `k3s-master-02` (192.168.5.21)
- atlas: `k3s-master-03` (192.168.5.22)
- venus: `k3s-master-04` (192.168.5.23)

Worker VMs:
- hades: `k3s-worker-01` (192.168.5.30)
- atlas: `k3s-worker-02` (192.168.5.31), `k3s-worker-03` (192.168.5.32)
- venus: `k3s-worker-04` (192.168.5.33), `k3s-worker-05` (192.168.5.34)

> Notes:
> - The provider is configured against `https://hades.lan:8006`.
> - Cloud-init user/password and SSH keys are injected via variables.

---

## Kubernetes Bootstrap + GitOps (FluxCD)

### FluxCD source of truth
Flux watches this Git repo and applies manifests from:

- `./kubernetes/clusters/production`

The Flux bootstrap creates:

- A `GitRepository` named `flux-system` (polling the `master` branch)
- A `Kustomization` named `flux-system` that applies everything in `./kubernetes/clusters/production`

### The reconciliation chain
The cluster converges in this order:

1. **infrastructure-controllers**
   - installs Helm controllers and base services (cert-manager, traefik, longhorn, reflector)
   - deploys Authelia
   - includes SOPS decryption (Age)

2. **infrastructure-configs**
   - configures TLS, middleware, and IngressRoutes

3. **apps**
   - deploys all app manifests under `kubernetes/apps/`
   - includes SOPS decryption (Age)

### Secrets management (SOPS + Age)
- Secrets are stored in Git as SOPS-encrypted YAML (`sops:` block present).
- Flux decrypts them at runtime using an Age private key stored in-cluster (referenced by `secretRef: sops-age` in the Flux Kustomizations).

---

## Ingress, TLS, and Authentication

### Traefik (Ingress)
Traefik is deployed via HelmRelease and serves as the entry point into the cluster.

Key behaviors:
- Uses an ingress class: `traefik-external`
- Provides HTTPS entrypoint: `websecure`
- Exposes service as `LoadBalancer` with static IP: `192.168.5.50`

### cert-manager (Certificates)
- Uses Let’s Encrypt ACME with DNS01 validation via Cloudflare.
- A wildcard certificate is created:
  - `efym.net` + `*.efym.net`
- Secret name: `efym-net-tls`
- Reflector annotations replicate the TLS secret into other namespaces.

### Authelia (Auth)
Authelia is used in two ways:
- **Forward-auth** middleware (Traefik Middleware object)
- **OIDC provider** for apps that support it (e.g. Karakeep, Jellyfin)

The Traefik middleware forwards auth to:
- `http://authelia.authelia.svc.cluster.local:9091/api/authz/forward-auth`

Apps and endpoints can then apply auth by referencing the middleware:
```yaml
middlewares:
  - name: authelia
    namespace: authelia
